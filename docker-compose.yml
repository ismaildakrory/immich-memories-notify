# ============================================================
# IMMICH MEMORIES NOTIFY - DOCKER COMPOSE
# ============================================================
#
# USAGE:
#   docker compose run --rm notify --slot 1              # Run slot 1
#   docker compose run --rm notify --slot 1 --test       # Test mode
#   docker compose run --rm notify --slot 1 --dry-run    # Preview only
#   docker compose run --rm notify --slot 1 --no-delay   # Skip random delay
#   docker compose up -d scheduler                       # Start scheduler
#   docker compose up -d dashboard                       # Start web dashboard
#
# SLOTS:
#   Slot 1-3: Memory notifications (if memories exist) or person photos
#   Slot 4-5: Person photo notifications
#
# CONFIGURATION:
#   - Secrets (API keys, passwords): .env
#   - Everything else (schedules, settings): config.yaml
#
# DASHBOARD:
#   - Access at http://localhost:5000
#   - Set DASHBOARD_TOKEN env var for authentication
#
# ============================================================

services:
  # ------------------------------------------------------------
  # Main Service - Run on demand
  # ------------------------------------------------------------
  notify:
    build: .
    container_name: immich-memories-notify
    volumes:
      - ./notify.py:/app/notify.py:ro
      - ./config.yaml:/app/config.yaml:ro
      - ./state.json:/app/state.json
      - /etc/localtime:/etc/localtime:ro
    env_file: .env
    environment:
      - TZ=${TZ:-UTC}   
    network_mode: host
    restart: "no"

  # ------------------------------------------------------------
  # Scheduler Service - Reads config from config.yaml
  # ------------------------------------------------------------
  scheduler:
    build: .
    container_name: immich-memories-scheduler
    volumes:
      - ./notify.py:/app/notify.py:ro
      - ./config.yaml:/app/config.yaml:ro
      - ./state.json:/app/state.json
      - /etc/localtime:/etc/localtime:ro
    env_file: .env
    environment:
      - TZ=${TZ:-UTC}
    network_mode: host
    restart: unless-stopped
    entrypoint: /bin/sh
    command:
      - -c
      - |
        echo "========================================"
        echo "Immich Memories Notify - Scheduler"
        echo "========================================"
        echo ""
        # Generate crontab from config.yaml using Python
        python -c "
        import yaml
        with open('config.yaml') as f:
            config = yaml.safe_load(f)
        windows = config.get('settings', {}).get('notification_windows', [])
        print('Notification windows (random time within each):')
        for i, w in enumerate(windows, 1):
            start = w.get('start', '08:00')
            end = w.get('end', '10:00')
            # Generate cron from start time (e.g., '08:00' -> '0 8 * * *')
            h, m = start.split(':')
            cron = f'{int(m)} {int(h)} * * *'
            print(f'  Slot {i}: {start}-{end} (triggers at {start})')
        print()
        # Write crontab
        with open('/etc/crontabs/root', 'w') as f:
            for i, w in enumerate(windows, 1):
                start = w.get('start', '08:00')
                h, m = start.split(':')
                cron = f'{int(m)} {int(h)} * * *'
                f.write(f'{cron} cd /app && python notify.py --slot {i} >> /proc/1/fd/1 2>&1\n')
        "
        echo "Starting scheduler..."
        crond -f -l 2

  # ------------------------------------------------------------
  # Dashboard Service - Web UI for managing notifications
  # ------------------------------------------------------------
  dashboard:
    build:
      context: .
      dockerfile: Dockerfile.dashboard
    container_name: immich-memories-dashboard
    ports:
      - "5000:5000"
    volumes:
      - ./config.yaml:/app/config.yaml
      - ./state.json:/app/state.json
      - ./notify.py:/app/notify.py:ro
      - ./.env:/app/.env
      - /var/run/docker.sock:/var/run/docker.sock
      - .:/app/project:ro
      - /etc/localtime:/etc/localtime:ro
    env_file: .env
    environment:
      - TZ=${TZ:-UTC}
      - CONFIG_PATH=/app/config.yaml
      - STATE_PATH=/app/state.json
      - ENV_PATH=/app/.env
      - PROJECT_DIR=/app/project
      - DASHBOARD_USER=${DASHBOARD_USER:-admin}
      - DASHBOARD_TOKEN=${DASHBOARD_TOKEN:-}
    network_mode: host
    restart: unless-stopped
